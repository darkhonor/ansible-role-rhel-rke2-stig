---
###############################################################################
# Filename: handlers/main.yml
# Role: ansible-role-rhel-rke2-stig
# Summary: Event handlers for RHEL RKE2 STIG compliance role
# Last Updated: 23 Jan 2026
# Classification: UNCLASSIFIED
###############################################################################
- name: Check if auditd is running
  ansible.builtin.command:
    cmd: systemctl is-active auditd
  register: auditd_active
  changed_when: false
  failed_when: false
  listen: Reload auditd rules

- name: Reload auditd rules
  ansible.builtin.command:
    cmd: augenrules --load
  changed_when: true
  when: auditd_active.rc == 0
  listen: Reload auditd rules

###############################################################################
# fapolicyd Handlers - Application Whitelisting
###############################################################################
- name: Check if fapolicyd is running
  ansible.builtin.command:
    cmd: systemctl is-active fapolicyd
  register: fapolicyd_active
  changed_when: false
  failed_when: false
  listen: Reload fapolicyd rules

- name: Update fapolicyd rules
  ansible.builtin.command:
    cmd: fapolicyd-cli --update
  changed_when: true
  when: fapolicyd_active.rc == 0
  listen: Reload fapolicyd rules

###############################################################################
# Sysctl Handlers - Kernel Parameter Tuning
# Note: sysctl --system may fail in containers where kernel parameters cannot
#   be modified. Config files are deployed regardless; settings apply on reboot
#   or when running on real hardware/VMs.
###############################################################################
- name: Reload sysctl
  ansible.builtin.command:
    cmd: sysctl --system
  changed_when: true
  failed_when: false
  listen: Reload sysctl

###############################################################################
# SSH Handlers - OpenSSH Server Configuration
###############################################################################
- name: Check if sshd is running
  ansible.builtin.command:
    cmd: systemctl is-active sshd
  register: sshd_active
  changed_when: false
  failed_when: false
  listen: Restart sshd

- name: Restart sshd service
  ansible.builtin.systemd:
    name: sshd
    state: restarted
  when: sshd_active.rc == 0
  listen: Restart sshd

###############################################################################
# NetworkManager Handlers - CNI Interface Configuration
###############################################################################
- name: Check if NetworkManager is running
  ansible.builtin.command:
    cmd: systemctl is-active NetworkManager
  register: networkmanager_active
  changed_when: false
  failed_when: false
  listen: Reload NetworkManager

- name: Reload NetworkManager configuration
  ansible.builtin.command:
    cmd: nmcli general reload conf
  changed_when: true
  when: networkmanager_active.rc == 0
  listen: Reload NetworkManager
