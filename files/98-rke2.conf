###############################################################################
# Filename: /etc/sysctl.d/98-rke2.conf
# Role: ansible-role-rhel-rke2-stig
# Summary: Kernel parameters optimized for RKE2 Kubernetes nodes. Includes
#   network tuning, memory management, and required settings for container
#   networking and high pod density environments.
# Last Updated: 23 Jan 2026
# Classification: UNCLASSIFIED
#
# Note: These settings supplement STIG-required kernel parameters. The 98-
#   prefix ensures these load after base STIG settings but can be overridden
#   if needed.
###############################################################################

###############################################################################
## REQUIRED FOR KUBERNETES POD NETWORKING
## These settings are CRITICAL - without them, pod networking will fail
###############################################################################

# Allow iptables to see bridged traffic (required for CNI)
net.bridge.bridge-nf-call-iptables = 1
net.bridge.bridge-nf-call-ip6tables = 1

# Enable IP forwarding (required for pod-to-pod communication)
net.ipv4.ip_forward = 1

###############################################################################
## REQUIRED FOR CONTAINER ISOLATION (EXEMPTION: RHEL-09-213105)
## User namespaces provide UID mapping for container security. Disabling them
## would reduce container isolation and break rootless container support.
## Document exemption with ISSM per STIG guidance.
###############################################################################

# Enable user namespaces for container UID mapping and isolation
# STIG RHEL-09-213105 wants 0; Kubernetes requires non-zero for pod isolation
user.max_user_namespaces = 15000

###############################################################################
## MEMORY AND SWAP SETTINGS
###############################################################################

# Disable swap preference (Kubernetes requires swap off or swappiness=0)
vm.swappiness = 0

# Don't panic on OOM - let the OOM killer handle it
vm.panic_on_oom = 0

# Allow memory overcommit (required for container memory limits)
vm.overcommit_memory = 1

# Increase max memory map areas (required for Elasticsearch, etc.)
vm.max_map_count = 262144

###############################################################################
## KERNEL PANIC SETTINGS
###############################################################################

# Reboot 10 seconds after kernel panic (for automated recovery)
kernel.panic = 10
kernel.panic_on_oops = 1

###############################################################################
## NETWORK TUNING FOR HIGH POD DENSITY
###############################################################################

# Increase local port range for high connection counts
net.ipv4.ip_local_port_range = 1024 65000

# Increase max connection backlog
net.core.somaxconn = 4096
net.core.netdev_max_backlog = 4096

# Reuse TIME_WAIT sockets faster (high connection churn)
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_fin_timeout = 15

# TCP buffer sizes (16MB max per socket)
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216
net.ipv4.tcp_rmem = 4096 87380 16777216
net.ipv4.tcp_wmem = 4096 65536 16777216

# TCP connection tuning
net.ipv4.tcp_max_syn_backlog = 20480
net.ipv4.tcp_max_tw_buckets = 400000
net.ipv4.tcp_no_metrics_save = 1
net.ipv4.tcp_syn_retries = 2
net.ipv4.tcp_synack_retries = 2

# TCP keepalive for long-lived connections
net.ipv4.tcp_keepalive_time = 600

###############################################################################
## ARP CACHE SETTINGS FOR HIGH POD COUNT
###############################################################################

# Increase ARP cache thresholds (prevents ARP table overflow)
net.ipv4.neigh.default.gc_thresh1 = 8096
net.ipv4.neigh.default.gc_thresh2 = 12288
net.ipv4.neigh.default.gc_thresh3 = 16384

###############################################################################
## CONNECTION TRACKING (CONNTRACK)
###############################################################################

# Increase conntrack table size for high pod count environments
# Default is typically 65536, which is insufficient for large clusters
net.netfilter.nf_conntrack_max = 1048576

###############################################################################
## INOTIFY SETTINGS (FILE WATCHERS)
###############################################################################

# Increase inotify limits (required for kubelet, container runtimes)
fs.inotify.max_user_instances = 8192
fs.inotify.max_user_watches = 1048576

###############################################################################
## END OF RKE2 SYSCTL SETTINGS
###############################################################################
