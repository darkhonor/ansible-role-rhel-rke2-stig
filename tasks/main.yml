---
###############################################################################
# Filename: tasks/main.yml
# Role: ansible-role-rhel-rke2-stig
# Summary: Ansible Role tasks for RHEL RKE2 STIG compliance
# Last Updated: 23 Jan 2026
# Classification: UNCLASSIFIED
###############################################################################
###########################################################
# STIG ID: RHEL-09-611075    Group ID: V-258104
# Rule Title: RHEL 9 passwords for new users or password changes must have a 24
#   hours minimum password lifetime restriction in /etc/login.defs.
# Severity: CAT II
###########################################################
- name: RHEL-09-611075 | Ensure minimum password lifetime is 24 hours
  ansible.builtin.lineinfile:
    path: /etc/login.defs
    regexp: '^\s*#*\s*PASS_MIN_DAYS\s+'
    line: 'PASS_MIN_DAYS 1'
    state: present
  tags:
    - RHEL-09-611075
    - CAT II

###########################################################
# STIG ID: RHEL-09-411010    Group ID: V-258041
# Rule Title: RHEL 9 user account passwords for new users or password changes
#   must have a 60-day maximum password lifetime restriction in /etc/login.defs.
# Severity: CAT II
###########################################################
- name: RHEL-09-411010 | Ensure maximum password lifetime is 60 days
  ansible.builtin.lineinfile:
    path: /etc/login.defs
    regexp: '^\s*#*\s*PASS_MAX_DAYS\s+'
    line: 'PASS_MAX_DAYS 60'
    state: present
  tags:
    - RHEL-09-411010
    - CAT II

###########################################################
# STIG IDs: RHEL-09-654010 through RHEL-09-654255
# Group IDs: V-258176 through V-258225
# Rule Title: Deploy all STIG-required audit rules for system call
#   monitoring, privileged command execution, and identity file changes.
#   This template covers 50 individual STIG audit requirements.
# Severity: CAT II
###########################################################
- name: RHEL-09-654xxx | Deploy STIG audit rules
  ansible.builtin.template:
    src: 20-stig.rules.j2
    dest: /etc/audit/rules.d/20-stig.rules
    owner: root
    group: root
    mode: '0640'
  notify: Reload auditd rules
  tags:
    - RHEL-09-654010
    - audit
    - CAT II

###########################################################
# STIG IDs: RHEL-09-213045, RHEL-09-213050, RHEL-09-213055,
#   RHEL-09-213060, RHEL-09-213065, RHEL-09-231195, RHEL-09-291010,
#   RHEL-09-291035
# Group IDs: V-257804 through V-257808, V-257880, V-258034, V-258039
# Rule Title: Deploy kernel module blacklist to disable unnecessary and
#   potentially dangerous kernel modules (ATM, CAN, FireWire, SCTP, TIPC,
#   cramfs, USB storage, Bluetooth). Covers 8 STIG requirements.
# Severity: CAT II / CAT III
###########################################################
- name: RHEL-09-213xxx | Deploy kernel module blacklist
  ansible.builtin.template:
    src: blacklist.conf.j2
    dest: /etc/modprobe.d/blacklist.conf
    owner: root
    group: root
    mode: '0644'
  tags:
    - RHEL-09-213045
    - kernel
    - CAT II

###########################################################
# STIG ID: RHEL-09-433016    Group ID: V-270180
# Rule Title: The RHEL 9 fapolicy module must be configured to employ a
#   deny-all, permit-by-exception policy to allow the execution of authorized
#   software programs.
# Severity: CAT II
# Note: Supplements RKE2 RPM-provided rules (80-rke2.rules) with additional
#   paths for Longhorn, local-path-provisioner, and optional components.
###########################################################
- name: RHEL-09-433016 | Deploy supplemental fapolicyd rules for RKE2
  ansible.builtin.template:
    src: 60-rke2.rules.j2
    dest: /etc/fapolicyd/rules.d/60-rke2.rules
    owner: root
    group: root
    mode: '0644'
  notify: Reload fapolicyd rules
  when: rhel_rke2_stig_fapolicyd_enabled | default(true)
  tags:
    - RHEL-09-433016
    - fapolicyd
    - CAT II

###########################################################
# STIG ID: N/A (Operational)    Group ID: N/A
# Rule Title: Load kernel modules required for RKE2 Kubernetes networking
#   including bridge/netfilter, IPVS, iptables, NAT, and overlay modules.
#   These modules are NOT on the STIG blacklist.
# Severity: N/A
###########################################################
- name: RKE2-MODULES | Deploy kernel modules configuration
  ansible.builtin.copy:
    src: rke2-modules.conf
    dest: /etc/modules-load.d/rke2-modules.conf
    owner: root
    group: root
    mode: '0644'
  tags:
    - rke2
    - kernel

###########################################################
# STIG ID: RHEL-09-253075 (EXEMPTION)    Group ID: V-257970
# Rule Title: RHEL 9 must not enable IPv4 packet forwarding unless the system
#   is a router. EXEMPTION REQUIRED: Kubernetes nodes require IP forwarding
#   for pod-to-pod networking. Document with ISSO per STIG guidance.
# Severity: CAT II
###########################################################
- name: RKE2-SYSCTL | Deploy sysctl settings (EXEMPTION RHEL-09-253075)
  ansible.builtin.copy:
    src: 98-rke2.conf
    dest: /etc/sysctl.d/98-rke2.conf
    owner: root
    group: root
    mode: '0644'
  notify: Reload sysctl
  tags:
    - rke2
    - sysctl
    - RHEL-09-253075
    - CAT II

###########################################################
# STIG ID: N/A (Operational)    Group ID: N/A
# Rule Title: Configure NetworkManager to ignore CNI-managed interfaces.
#   Prevents interference with Canal/Calico/Flannel virtual interfaces.
# Severity: N/A
###########################################################
- name: RKE2-NETWORK | Deploy NetworkManager CNI ignore configuration
  ansible.builtin.copy:
    src: rke2-canal.conf
    dest: /etc/NetworkManager/conf.d/rke2-canal.conf
    owner: root
    group: root
    mode: '0644'
  notify: Reload NetworkManager
  tags:
    - rke2
    - networkmanager

###########################################################
# STIG ID: N/A (Supplements AU-2, AU-3, AU-12)    Group ID: N/A
# Rule Title: Deploy RKE2-specific audit rules for Kubernetes environments.
#   Audits RKE2 binaries, config, PKI, container runtime, network changes.
# Severity: CAT II
###########################################################
- name: RKE2-AUDIT | Deploy RKE2-specific audit rules
  ansible.builtin.copy:
    src: 10-rke2-server.rules
    dest: /etc/audit/rules.d/10-rke2-server.rules
    owner: root
    group: root
    mode: '0640'
  notify: Reload auditd rules
  tags:
    - rke2
    - audit
    - CAT II

###########################################################
# STIG ID: RHEL-09-251015 (EXEMPTION)    Group ID: V-257936
# Rule Title: The firewalld service on RHEL 9 must be active. EXEMPTION
#   REQUIRED: RKE2 uses iptables directly for pod networking. Running
#   firewalld concurrently causes unpredictable cluster failures. RKE2's
#   iptables rules provide equivalent network filtering.
# Severity: CAT II
# Also Affects: RHEL-09-251020 (V-257937) - deny-all firewall policy
###########################################################
- name: RKE2-FIREWALL | Disable firewalld (EXEMPTION RHEL-09-251015)
  ansible.builtin.systemd:
    name: firewalld
    state: stopped
    enabled: false
    masked: true
  tags:
    - rke2
    - firewall
    - RHEL-09-251015
    - RHEL-09-251020
    - CAT II
