---
###############################################################################
# Filename: tasks/main.yml
# Role: ansible-role-rhel-rke2-stig
# Summary: Ansible Role tasks for RHEL RKE2 STIG compliance
# Last Updated: 23 Jan 2026
# Classification: UNCLASSIFIED
###############################################################################
###########################################################
# STIG ID: RHEL-09-611075    Group ID: V-258104
# Rule Title: RHEL 9 passwords for new users or password changes must have a 24
#   hours minimum password lifetime restriction in /etc/login.defs.
# Severity: CAT II
###########################################################
- name: RHEL-09-611075 | Ensure minimum password lifetime is 24 hours
  ansible.builtin.lineinfile:
    path: /etc/login.defs
    regexp: '^\s*#*\s*PASS_MIN_DAYS\s+'
    line: 'PASS_MIN_DAYS 1'
    state: present
  tags:
    - RHEL-09-611075
    - CAT II

###########################################################
# STIG ID: RHEL-09-411010    Group ID: V-258041
# Rule Title: RHEL 9 user account passwords for new users or password changes
#   must have a 60-day maximum password lifetime restriction in /etc/login.defs.
# Severity: CAT II
###########################################################
- name: RHEL-09-411010 | Ensure maximum password lifetime is 60 days
  ansible.builtin.lineinfile:
    path: /etc/login.defs
    regexp: '^\s*#*\s*PASS_MAX_DAYS\s+'
    line: 'PASS_MAX_DAYS 60'
    state: present
  tags:
    - RHEL-09-411010
    - CAT II

###########################################################
# STIG ID: RHEL-09-215105    Group ID: V-258241
# Rule Title: RHEL 9 must implement a FIPS 140-3-compliant systemwide
#   cryptographic policy.
# Severity: CAT II
# Note: Default policy is FIPS:AD-SUPPORT which maintains FIPS 140-3
#   compliance while enabling Kerberos interoperability with Active Directory.
#   The underlying crypto modules remain FIPS-validated; only Kerberos gets
#   RC4 exception for AD compatibility. See README.md for exemption details.
# Container Note: In containers without kernel FIPS mode, update-crypto-policies
#   may return rc=3 even when the policy is set. We check the state file for
#   idempotence rather than command output.
###########################################################
- name: RHEL-09-215105 | Check current cryptographic policy
  ansible.builtin.slurp:
    src: /etc/crypto-policies/state/current
  register: rhel_rke2_stig_crypto_policy_current
  failed_when: false
  when: rhel_rke2_stig_crypto_policy_enabled | default(true)
  tags:
    - RHEL-09-215105
    - crypto
    - CAT II

- name: RHEL-09-215105 | Set system-wide cryptographic policy
  ansible.builtin.command:
    cmd: update-crypto-policies --set {{ rhel_rke2_stig_crypto_policy }}
  register: rhel_rke2_stig_crypto_policy_result
  changed_when: "'Setting system policy' in rhel_rke2_stig_crypto_policy_result.stdout"
  failed_when:
    - rhel_rke2_stig_crypto_policy_result.rc != 0
    - "'Setting system policy' not in rhel_rke2_stig_crypto_policy_result.stdout"
  when:
    - rhel_rke2_stig_crypto_policy_enabled | default(true)
    - (rhel_rke2_stig_crypto_policy_current.content | default('') | b64decode | trim) != rhel_rke2_stig_crypto_policy
  tags:
    - RHEL-09-215105
    - crypto
    - CAT II

###########################################################
# STIG ID: RHEL-09-213040    Group ID: V-257802
# Rule Title: RHEL 9 must disable the kernel.core_pattern.
# Severity: CAT II
# Note: Piping core dumps to /bin/false prevents sensitive memory contents
#   from being written to disk. This is a general STIG requirement applied
#   directly to /etc/sysctl.conf.
###########################################################
- name: RHEL-09-213040 | Disable core dumps via kernel.core_pattern
  ansible.posix.sysctl:
    name: kernel.core_pattern
    value: '|/bin/false'
    state: present
    sysctl_file: /etc/sysctl.conf
    reload: false
  notify: Reload sysctl
  tags:
    - RHEL-09-213040
    - kernel
    - CAT II

###########################################################
# STIG ID: RHEL-09-213080    Group ID: V-257810
# Rule Title: RHEL 9 must restrict the use of the ptrace system call to
#   descendants of a process only.
# Severity: CAT II
# Note: Setting ptrace_scope to 1 limits process debugging/tracing to child
#   processes only, reducing attack surface. Applied directly to /etc/sysctl.conf.
###########################################################
- name: RHEL-09-213080 | Restrict ptrace to descendant processes
  ansible.posix.sysctl:
    name: kernel.yama.ptrace_scope
    value: '1'
    state: present
    sysctl_file: /etc/sysctl.conf
    reload: false
  notify: Reload sysctl
  tags:
    - RHEL-09-213080
    - kernel
    - CAT II

###########################################################
# STIG ID: RHEL-09-253050    Group ID: V-257965
# Rule Title: RHEL 9 must use a reverse-path filter for IPv4 network
#   traffic when possible by default.
# Severity: CAT II
# Note: Reverse-path filtering helps prevent IP spoofing attacks by
#   verifying source addresses. Applied directly to /etc/sysctl.conf.
###########################################################
- name: RHEL-09-253050 | Enable reverse-path filter for IPv4 by default
  ansible.posix.sysctl:
    name: net.ipv4.conf.default.rp_filter
    value: '1'
    state: present
    sysctl_file: /etc/sysctl.conf
    reload: false
  notify: Reload sysctl
  tags:
    - RHEL-09-253050
    - network
    - CAT II

###########################################################
# STIG ID: RHEL-09-255095    Group ID: V-257995
# Rule Title: RHEL 9 must be configured so that all network connections
#   associated with SSH traffic terminate after becoming unresponsive.
# Severity: CAT II
# Note: Works in conjunction with ClientAliveInterval (RHEL-09-255100) to
#   terminate unresponsive sessions.
###########################################################
- name: RHEL-09-255095 | Check if sshd_config exists
  ansible.builtin.stat:
    path: /etc/ssh/sshd_config
  register: rhel_rke2_stig_sshd_config_check
  when: rhel_rke2_stig_ssh_enabled | default(true)
  tags:
    - RHEL-09-255095
    - RHEL-09-255100
    - ssh
    - CAT II

- name: RHEL-09-255095 | Set SSH ClientAliveCountMax
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^\s*#*\s*ClientAliveCountMax\s+'
    line: 'ClientAliveCountMax {{ rhel_rke2_stig_ssh_client_alive_count_max }}'
    state: present
  notify: Restart sshd
  when:
    - rhel_rke2_stig_ssh_enabled | default(true)
    - rhel_rke2_stig_sshd_config_check.stat.exists | default(false)
  tags:
    - RHEL-09-255095
    - ssh
    - CAT II

###########################################################
# STIG ID: RHEL-09-255100    Group ID: V-257996
# Rule Title: RHEL 9 must be configured so that all network connections
#   associated with SSH traffic are terminated after 10 minutes of becoming
#   unresponsive.
# Severity: CAT II
# Note: ClientAliveInterval * ClientAliveCountMax = max idle time before
#   disconnect. With CountMax=1 and Interval=600, session terminates after
#   10 minutes of unresponsiveness.
###########################################################
- name: RHEL-09-255100 | Set SSH ClientAliveInterval
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^\s*#*\s*ClientAliveInterval\s+'
    line: 'ClientAliveInterval {{ rhel_rke2_stig_ssh_client_alive_interval }}'
    state: present
  notify: Restart sshd
  when:
    - rhel_rke2_stig_ssh_enabled | default(true)
    - rhel_rke2_stig_sshd_config_check.stat.exists | default(false)
  tags:
    - RHEL-09-255100
    - ssh
    - CAT II

###########################################################
# STIG ID: RHEL-09-255035    Group ID: V-257983
# Rule Title: RHEL 9 SSHD must accept public key authentication.
# Severity: CAT II
# Note: If an approved alternate multifactor authentication method is used,
#   this requirement is Not Applicable.
###########################################################
- name: RHEL-09-255035 | Enable SSH public key authentication
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^\s*#*\s*PubkeyAuthentication\s+'
    line: 'PubkeyAuthentication yes'
    state: present
  notify: Restart sshd
  when:
    - rhel_rke2_stig_ssh_enabled | default(true)
    - rhel_rke2_stig_sshd_config_check.stat.exists | default(false)
  tags:
    - RHEL-09-255035
    - ssh
    - CAT II

###########################################################
# STIG ID: RHEL-09-255070    Group ID: V-270178
# Rule Title: The RHEL 9 SSH client must be configured to use only
#   DOD-approved Message Authentication Codes (MACs) employing FIPS 140-3
#   validated cryptographic hash algorithms to protect the confidentiality
#   of SSH client connections.
# Severity: CAT II
# Note: OSCAP checks require MACs in specific order. The crypto policy
#   backend file is used rather than sshd_config per STIG guidance.
###########################################################
- name: RHEL-09-255070 | Configure SSH client crypto policy MACs
  ansible.builtin.lineinfile:
    path: /etc/crypto-policies/back-ends/openssh.config
    regexp: '^MACs\s+'
    line: "MACs hmac-sha2-256-etm@openssh.com,hmac-sha2-512-etm@openssh.com,hmac-sha2-256,hmac-sha2-512"
    create: true
    owner: root
    group: root
    mode: '0644'
  notify: Restart sshd
  when:
    - rhel_rke2_stig_ssh_enabled | default(true)
    - rhel_rke2_stig_sshd_config_check.stat.exists | default(false)
  tags:
    - RHEL-09-255070
    - ssh
    - CAT II

###########################################################
# STIG ID: RHEL-09-255075    Group ID: V-257991
# Rule Title: The RHEL 9 SSH server must be configured to use only Message
#   Authentication Codes (MACs) employing FIPS 140-3 validated cryptographic
#   hash algorithms to protect the confidentiality of SSH server connections.
# Severity: CAT II
# Note: OSCAP checks require MACs in specific order. The crypto policy
#   backend file is used rather than sshd_config per STIG guidance.
###########################################################
- name: RHEL-09-255075 | Configure SSH server crypto policy MACs
  ansible.builtin.lineinfile:
    path: /etc/crypto-policies/back-ends/opensshserver.config
    regexp: '^MACs\s+'
    line: "MACs hmac-sha2-256-etm@openssh.com,hmac-sha2-512-etm@openssh.com,hmac-sha2-256,hmac-sha2-512"
    create: true
    owner: root
    group: root
    mode: '0644'
  notify: Restart sshd
  when:
    - rhel_rke2_stig_ssh_enabled | default(true)
    - rhel_rke2_stig_sshd_config_check.stat.exists | default(false)
  tags:
    - RHEL-09-255075
    - ssh
    - CAT II

###########################################################
# STIG ID: RHEL-09-255070    Group ID: V-270178
# Rule Title: The RHEL 9 SSH client must be configured to use only
#   DOD-approved Message Authentication Codes (MACs) employing FIPS 140-3
#   validated cryptographic hash algorithms to protect the confidentiality
#   of SSH client connections.
# Severity: CAT II
# Note: MACs in ssh_config override crypto policy. Remove to ensure policy
#   backend settings take effect.
###########################################################
- name: RHEL-09-255070 | Remove MACs override from SSH client config
  ansible.builtin.lineinfile:
    path: /etc/ssh/ssh_config
    regexp: '^\s*MACs\s+'
    state: absent
  notify: Restart sshd
  when: rhel_rke2_stig_ssh_enabled | default(true)
  tags:
    - RHEL-09-255070
    - ssh
    - CAT II

###########################################################
# STIG ID: RHEL-09-255075    Group ID: V-257991
# Rule Title: The RHEL 9 SSH server must be configured to use only Message
#   Authentication Codes (MACs) employing FIPS 140-3 validated cryptographic
#   hash algorithms to protect the confidentiality of SSH server connections.
# Severity: CAT II
# Note: MACs in sshd_config override crypto policy. Remove to ensure policy
#   backend settings take effect.
###########################################################
- name: RHEL-09-255075 | Remove MACs override from SSH server config
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^\s*MACs\s+'
    state: absent
  notify: Restart sshd
  when:
    - rhel_rke2_stig_ssh_enabled | default(true)
    - rhel_rke2_stig_sshd_config_check.stat.exists | default(false)
  tags:
    - RHEL-09-255075
    - ssh
    - CAT II

###########################################################
# STIG ID: RHEL-09-252040    Group ID: V-257949
# Rule Title: RHEL 9 must configure a DNS processing mode in Network Manager.
# Severity: CAT II
# Note: Common DNS modes are 'default' (use resolv.conf), 'dnsmasq', or
#   'systemd-resolved'. 'default' maintains traditional DNS resolution behavior.
###########################################################
- name: RHEL-09-252040 | Check if NetworkManager is installed
  ansible.builtin.stat:
    path: /etc/NetworkManager/NetworkManager.conf
  register: rhel_rke2_stig_nm_conf_check
  when: rhel_rke2_stig_nm_dns_enabled | default(true)
  tags:
    - RHEL-09-252040
    - networkmanager
    - CAT II

- name: RHEL-09-252040 | Configure NetworkManager DNS mode
  community.general.ini_file:
    path: /etc/NetworkManager/NetworkManager.conf
    section: main
    option: dns
    value: '{{ rhel_rke2_stig_nm_dns_mode }}'
    mode: '0644'
    backup: true
  notify: Reload NetworkManager
  when:
    - rhel_rke2_stig_nm_dns_enabled | default(true)
    - rhel_rke2_stig_nm_conf_check.stat.exists | default(false)
  tags:
    - RHEL-09-252040
    - networkmanager
    - CAT II

###########################################################
# STIG IDs: RHEL-09-654010 through RHEL-09-654255
# Group IDs: V-258176 through V-258225
# Rule Title: Deploy all STIG-required audit rules for system call
#   monitoring, privileged command execution, and identity file changes.
#   This template covers 50 individual STIG audit requirements.
# Severity: CAT II
###########################################################
- name: RHEL-09-654xxx | Deploy STIG audit rules
  ansible.builtin.template:
    src: 20-stig.rules.j2
    dest: /etc/audit/rules.d/20-stig.rules
    owner: root
    group: root
    mode: '0640'
  notify: Reload auditd rules
  tags:
    - RHEL-09-654010
    - audit
    - CAT II

###########################################################
# STIG IDs: RHEL-09-213045, RHEL-09-213050, RHEL-09-213055,
#   RHEL-09-213060, RHEL-09-213065, RHEL-09-231195, RHEL-09-291010,
#   RHEL-09-291035
# Group IDs: V-257804 through V-257808, V-257880, V-258034, V-258039
# Rule Title: Deploy kernel module blacklist to disable unnecessary and
#   potentially dangerous kernel modules (ATM, CAN, FireWire, SCTP, TIPC,
#   cramfs, USB storage, Bluetooth). Covers 8 STIG requirements.
# Severity: CAT II / CAT III
###########################################################
- name: RHEL-09-213xxx | Deploy kernel module blacklist
  ansible.builtin.template:
    src: blacklist.conf.j2
    dest: /etc/modprobe.d/blacklist.conf
    owner: root
    group: root
    mode: '0644'
  tags:
    - RHEL-09-213045
    - kernel
    - CAT II

###########################################################
# STIG ID: RHEL-09-433016    Group ID: V-270180
# Rule Title: The RHEL 9 fapolicy module must be configured to employ a
#   deny-all, permit-by-exception policy to allow the execution of authorized
#   software programs.
# Severity: CAT II
# Note: Supplements RKE2 RPM-provided rules (80-rke2.rules) with additional
#   paths for Longhorn, local-path-provisioner, and optional components.
###########################################################
- name: RHEL-09-433016 | Deploy supplemental fapolicyd rules for RKE2
  ansible.builtin.template:
    src: 60-rke2.rules.j2
    dest: /etc/fapolicyd/rules.d/60-rke2.rules
    owner: root
    group: root
    mode: '0644'
  notify: Reload fapolicyd rules
  when: rhel_rke2_stig_fapolicyd_enabled | default(true)
  tags:
    - RHEL-09-433016
    - fapolicyd
    - CAT II

###########################################################
# STIG ID: N/A (Operational)    Group ID: N/A
# Rule Title: Load kernel modules required for RKE2 Kubernetes networking
#   including bridge/netfilter, IPVS, iptables, NAT, and overlay modules.
#   These modules are NOT on the STIG blacklist.
# Severity: N/A
###########################################################
- name: RKE2-MODULES | Deploy kernel modules configuration
  ansible.builtin.copy:
    src: rke2-modules.conf
    dest: /etc/modules-load.d/rke2-modules.conf
    owner: root
    group: root
    mode: '0644'
  tags:
    - rke2
    - kernel

###########################################################
# STIG ID: RHEL-09-253075 (EXEMPTION)    Group ID: V-257970
# Rule Title: RHEL 9 must not enable IPv4 packet forwarding unless the system
#   is a router. EXEMPTION REQUIRED: Kubernetes nodes require IP forwarding
#   for pod-to-pod networking. Document with ISSO per STIG guidance.
# Severity: CAT II
###########################################################
- name: RKE2-SYSCTL | Deploy sysctl settings (EXEMPTION RHEL-09-253075)
  ansible.builtin.copy:
    src: 98-rke2.conf
    dest: /etc/sysctl.d/98-rke2.conf
    owner: root
    group: root
    mode: '0644'
  notify: Reload sysctl
  tags:
    - rke2
    - sysctl
    - RHEL-09-253075
    - CAT II

###########################################################
# STIG ID: RHEL-09-253075, RHEL-09-213105 (EXEMPTIONS)
# Rule Title: Override STIG base sysctl settings that conflict with
#   Kubernetes networking. Uses 99-zzz- prefix to load AFTER the STIG
#   base config (99-sysctl.conf symlink to /etc/sysctl.conf).
# Severity: CAT II
# Note: STIG profile sets net.ipv4.conf.all.forwarding=0 which conflicts
#   with Kubernetes requirements. This file ensures our exempted settings
#   take precedence regardless of STIG base configuration.
###########################################################
- name: RKE2-SYSCTL | Deploy STIG override sysctl settings
  ansible.builtin.template:
    src: 99-zzz-rke2-stig-override.conf.j2
    dest: /etc/sysctl.d/99-zzz-rke2-stig-override.conf
    owner: root
    group: root
    mode: '0644'
  notify: Reload sysctl
  tags:
    - rke2
    - sysctl
    - RHEL-09-253075
    - RHEL-09-213105
    - CAT II

###########################################################
# STIG ID: N/A (Operational)    Group ID: N/A
# Rule Title: Configure NetworkManager to ignore CNI-managed interfaces.
#   Prevents interference with Canal/Calico/Flannel virtual interfaces.
# Severity: N/A
###########################################################
- name: RKE2-NETWORK | Deploy NetworkManager CNI ignore configuration
  ansible.builtin.copy:
    src: rke2-canal.conf
    dest: /etc/NetworkManager/conf.d/rke2-canal.conf
    owner: root
    group: root
    mode: '0644'
  notify: Reload NetworkManager
  tags:
    - rke2
    - networkmanager

###########################################################
# STIG ID: N/A (Supplements AU-2, AU-3, AU-12)    Group ID: N/A
# Rule Title: Deploy RKE2-specific audit rules for Kubernetes environments.
#   Audits RKE2 binaries, config, PKI, container runtime, network changes.
# Severity: CAT II
###########################################################
- name: RKE2-AUDIT | Deploy RKE2-specific audit rules
  ansible.builtin.copy:
    src: 10-rke2-server.rules
    dest: /etc/audit/rules.d/10-rke2-server.rules
    owner: root
    group: root
    mode: '0640'
  notify: Reload auditd rules
  tags:
    - rke2
    - audit
    - CAT II

###########################################################
# STIG ID: RHEL-09-251015 (EXEMPTION)    Group ID: V-257936
# Rule Title: The firewalld service on RHEL 9 must be active. EXEMPTION
#   REQUIRED: RKE2 uses iptables directly for pod networking. Running
#   firewalld concurrently causes unpredictable cluster failures. RKE2's
#   iptables rules provide equivalent network filtering.
# Severity: CAT II
# Also Affects: RHEL-09-251020 (V-257937) - deny-all firewall policy
###########################################################
- name: RKE2-FIREWALL | Disable firewalld (EXEMPTION RHEL-09-251015)
  ansible.builtin.systemd:
    name: firewalld
    state: stopped
    enabled: false
    masked: true
  tags:
    - rke2
    - firewall
    - RHEL-09-251015
    - RHEL-09-251020
    - CAT II
