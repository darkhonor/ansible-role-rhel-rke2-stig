---
###############################################################################
# Filename: tasks/main.yml
# Role: ansible-role-rhel-rke2-stig
# Summary: Ansible Role tasks for RHEL RKE2 STIG compliance
# Last Updated: 23 Jan 2026
# Classification: UNCLASSIFIED
###############################################################################
###########################################################
# STIG ID: RHEL-09-611075    Group ID: V-258104
# Rule Title: RHEL 9 passwords for new users or password changes must have a 24
#   hours minimum password lifetime restriction in /etc/login.defs.
# Severity: CAT II
###########################################################
- name: RHEL-09-611075 | Ensure minimum password lifetime is 24 hours
  ansible.builtin.lineinfile:
    path: /etc/login.defs
    regexp: '^\s*#*\s*PASS_MIN_DAYS\s+'
    line: 'PASS_MIN_DAYS 1'
    state: present
  tags:
    - RHEL-09-611075
    - CAT II

###########################################################
# STIG ID: RHEL-09-411010    Group ID: V-258041
# Rule Title: RHEL 9 user account passwords for new users or password changes
#   must have a 60-day maximum password lifetime restriction in /etc/login.defs.
# Severity: CAT II
###########################################################
- name: RHEL-09-411010 | Ensure maximum password lifetime is 60 days
  ansible.builtin.lineinfile:
    path: /etc/login.defs
    regexp: '^\s*#*\s*PASS_MAX_DAYS\s+'
    line: 'PASS_MAX_DAYS 60'
    state: present
  tags:
    - RHEL-09-411010
    - CAT II

###########################################################
# STIG ID: RHEL-09-611050    Group ID: V-258099
# Rule Title: RHEL 9 password-auth must be configured to use a sufficient
#   number of hashing rounds.
# Severity: CAT II
# Note: Uses community.general.pamd to modify PAM configuration safely.
#   Requires minimum 100000 rounds per STIG.
###########################################################
- name: RHEL-09-611050 | Check if password-auth exists
  ansible.builtin.stat:
    path: /etc/pam.d/password-auth
  register: rhel_rke2_stig_password_auth_check
  when: rhel_rke2_stig_pam_password_enabled | default(true)
  tags:
    - RHEL-09-611050
    - pam
    - CAT II

- name: RHEL-09-611050 | Configure SHA512 hashing rounds in password-auth
  community.general.pamd:
    name: password-auth
    type: password
    control: sufficient
    module_path: pam_unix.so
    module_arguments:
      - sha512
      - "rounds={{ rhel_rke2_stig_pam_sha512_rounds }}"
    state: args_present
  when:
    - rhel_rke2_stig_pam_password_enabled | default(true)
    - rhel_rke2_stig_password_auth_check.stat.exists | default(false)
  tags:
    - RHEL-09-611050
    - pam
    - CAT II

###########################################################
# STIG ID: RHEL-09-611055    Group ID: V-258100
# Rule Title: RHEL 9 system-auth must be configured to use a sufficient
#   number of hashing rounds.
# Severity: CAT II
# Note: Uses community.general.pamd to modify PAM configuration safely.
#   Requires minimum 100000 rounds per STIG.
###########################################################
- name: RHEL-09-611055 | Check if system-auth exists
  ansible.builtin.stat:
    path: /etc/pam.d/system-auth
  register: rhel_rke2_stig_system_auth_check
  when: rhel_rke2_stig_pam_password_enabled | default(true)
  tags:
    - RHEL-09-611055
    - pam
    - CAT II

- name: RHEL-09-611055 | Configure SHA512 hashing rounds in system-auth
  community.general.pamd:
    name: system-auth
    type: password
    control: sufficient
    module_path: pam_unix.so
    module_arguments:
      - sha512
      - "rounds={{ rhel_rke2_stig_pam_sha512_rounds }}"
    state: args_present
  when:
    - rhel_rke2_stig_pam_password_enabled | default(true)
    - rhel_rke2_stig_system_auth_check.stat.exists | default(false)
  tags:
    - RHEL-09-611055
    - pam
    - CAT II

###########################################################
# STIG ID: RHEL-09-611160    Group ID: V-258121
# Rule Title: RHEL 9 must use the common access card (CAC) smart card driver.
# Severity: CAT II
# Note: Configures OpenSC to use the CAC driver for DoD smart cards.
#   Only enable if your environment uses CAC/PIV authentication.
###########################################################
- name: RHEL-09-611160 | Check if opensc-tool is available
  ansible.builtin.command:
    cmd: which opensc-tool
  register: rhel_rke2_stig_opensc_check
  changed_when: false
  failed_when: false
  when: rhel_rke2_stig_smartcard_enabled | default(false)
  tags:
    - RHEL-09-611160
    - smartcard
    - CAT II

- name: RHEL-09-611160 | Configure CAC smart card driver
  ansible.builtin.command:
    cmd: opensc-tool --set-conf-entry app:default:card_drivers:cac
  register: rhel_rke2_stig_cac_result
  changed_when: rhel_rke2_stig_cac_result.rc == 0
  notify: Restart pcscd
  when:
    - rhel_rke2_stig_smartcard_enabled | default(false)
    - rhel_rke2_stig_opensc_check.rc == 0
  tags:
    - RHEL-09-611160
    - smartcard
    - CAT II

###########################################################
# STIG ID: RHEL-09-631020    Group ID: V-258133
# Rule Title: RHEL 9 must prohibit the use of cached authenticators after
#   one day.
# Severity: CAT II
# Note: Sets offline_credentials_expiration in sssd.conf. Only applies when
#   cache_credentials = true. Configure domain-specific settings as needed.
###########################################################
- name: RHEL-09-631020 | Check if sssd.conf exists
  ansible.builtin.stat:
    path: /etc/sssd/sssd.conf
  register: rhel_rke2_stig_sssd_conf_check
  when: rhel_rke2_stig_sssd_enabled | default(false)
  tags:
    - RHEL-09-631020
    - sssd
    - CAT II

- name: RHEL-09-631020 | Set offline credentials expiration
  community.general.ini_file:
    path: /etc/sssd/sssd.conf
    section: pam
    option: offline_credentials_expiration
    value: "{{ rhel_rke2_stig_sssd_offline_cred_expiration }}"
    mode: '0600'
    backup: true
  notify: Restart sssd
  when:
    - rhel_rke2_stig_sssd_enabled | default(false)
    - rhel_rke2_stig_sssd_conf_check.stat.exists | default(false)
  tags:
    - RHEL-09-631020
    - sssd
    - CAT II

###########################################################
# STIG ID: RHEL-09-631015    Group ID: V-258132
# Rule Title: RHEL 9 must map the authenticated identity to the user or
#   group account for PKI-based authentication.
# Severity: CAT II
# Note: Creates certmap section in sssd.conf for certificate-to-user mapping.
#   Configuration is highly environment-specific; adjust matchrule and maprule
#   variables to match your certificate format and directory schema.
###########################################################
- name: RHEL-09-631015 | Configure certificate mapping section
  community.general.ini_file:
    path: /etc/sssd/sssd.conf
    section: "certmap/{{ rhel_rke2_stig_sssd_certmap_domain }}/{{ rhel_rke2_stig_sssd_certmap_rule_name }}"
    option: "{{ item.option }}"
    value: "{{ item.value }}"
    mode: '0600'
    backup: true
  loop:
    - { option: 'matchrule', value: '{{ rhel_rke2_stig_sssd_certmap_matchrule }}' }
    - { option: 'maprule', value: '{{ rhel_rke2_stig_sssd_certmap_maprule }}' }
    - { option: 'domains', value: '{{ rhel_rke2_stig_sssd_certmap_domain }}' }
  notify: Restart sssd
  when:
    - rhel_rke2_stig_sssd_enabled | default(false)
    - rhel_rke2_stig_sssd_certmap_enabled | default(false)
    - rhel_rke2_stig_sssd_conf_check.stat.exists | default(false)
    - rhel_rke2_stig_sssd_certmap_domain | length > 0
  tags:
    - RHEL-09-631015
    - sssd
    - CAT II

###########################################################
# STIG ID: RHEL-09-215105    Group ID: V-258241
# Rule Title: RHEL 9 must implement a FIPS 140-3-compliant systemwide
#   cryptographic policy.
# Severity: CAT II
# Note: Default policy is FIPS:AD-SUPPORT which maintains FIPS 140-3
#   compliance while enabling Kerberos interoperability with Active Directory.
#   The underlying crypto modules remain FIPS-validated; only Kerberos gets
#   RC4 exception for AD compatibility. See README.md for exemption details.
# Container Note: In containers without kernel FIPS mode, update-crypto-policies
#   may return rc=3 even when the policy is set. We check the state file for
#   idempotence rather than command output.
###########################################################
- name: RHEL-09-215105 | Check current cryptographic policy
  ansible.builtin.slurp:
    src: /etc/crypto-policies/state/current
  register: rhel_rke2_stig_crypto_policy_current
  failed_when: false
  when: rhel_rke2_stig_crypto_policy_enabled | default(true)
  tags:
    - RHEL-09-215105
    - crypto
    - CAT II

- name: RHEL-09-215105 | Set system-wide cryptographic policy
  ansible.builtin.command:
    cmd: update-crypto-policies --set {{ rhel_rke2_stig_crypto_policy }}
  register: rhel_rke2_stig_crypto_policy_result
  changed_when: "'Setting system policy' in rhel_rke2_stig_crypto_policy_result.stdout"
  failed_when:
    - rhel_rke2_stig_crypto_policy_result.rc != 0
    - "'Setting system policy' not in rhel_rke2_stig_crypto_policy_result.stdout"
  when:
    - rhel_rke2_stig_crypto_policy_enabled | default(true)
    - (rhel_rke2_stig_crypto_policy_current.content | default('') | b64decode | trim) != rhel_rke2_stig_crypto_policy
  tags:
    - RHEL-09-215105
    - crypto
    - CAT II

###########################################################
# STIG ID: RHEL-09-213040    Group ID: V-257802
# Rule Title: RHEL 9 must disable the kernel.core_pattern.
# Severity: CAT II
# Note: Piping core dumps to /bin/false prevents sensitive memory contents
#   from being written to disk. This is a general STIG requirement applied
#   directly to /etc/sysctl.conf.
###########################################################
- name: RHEL-09-213040 | Disable core dumps via kernel.core_pattern
  ansible.posix.sysctl:
    name: kernel.core_pattern
    value: '|/bin/false'
    state: present
    sysctl_file: /etc/sysctl.conf
    reload: false
  notify: Reload sysctl
  tags:
    - RHEL-09-213040
    - kernel
    - CAT II

###########################################################
# STIG ID: RHEL-09-213080    Group ID: V-257810
# Rule Title: RHEL 9 must restrict the use of the ptrace system call to
#   descendants of a process only.
# Severity: CAT II
# Note: Setting ptrace_scope to 1 limits process debugging/tracing to child
#   processes only, reducing attack surface. Applied directly to /etc/sysctl.conf.
###########################################################
- name: RHEL-09-213080 | Restrict ptrace to descendant processes
  ansible.posix.sysctl:
    name: kernel.yama.ptrace_scope
    value: '1'
    state: present
    sysctl_file: /etc/sysctl.conf
    reload: false
  notify: Reload sysctl
  tags:
    - RHEL-09-213080
    - kernel
    - CAT II

###########################################################
# STIG ID: RHEL-09-253050    Group ID: V-257965
# Rule Title: RHEL 9 must use a reverse-path filter for IPv4 network
#   traffic when possible by default.
# Severity: CAT II
# Note: Reverse-path filtering helps prevent IP spoofing attacks by
#   verifying source addresses. Applied directly to /etc/sysctl.conf.
###########################################################
- name: RHEL-09-253050 | Enable reverse-path filter for IPv4 by default
  ansible.posix.sysctl:
    name: net.ipv4.conf.default.rp_filter
    value: '1'
    state: present
    sysctl_file: /etc/sysctl.conf
    reload: false
  notify: Reload sysctl
  tags:
    - RHEL-09-253050
    - network
    - CAT II

###########################################################
# STIG ID: RHEL-09-232040    Group ID: V-257888
# Rule Title: RHEL 9 permissions of cron configuration files and directories
#   must not be modified from the operating system defaults.
# Severity: CAT II
# Note: Uses rpm --setperms and --setugids to restore factory permissions
#   for cronie and crontabs packages.
###########################################################
- name: RHEL-09-232040 | Check if cronie package is installed
  ansible.builtin.command:
    cmd: rpm -q cronie
  register: rhel_rke2_stig_cronie_check
  changed_when: false
  failed_when: false
  when:
    - rhel_rke2_stig_file_permissions_enabled | default(true)
    - rhel_rke2_stig_cron_permissions_enabled | default(true)
  tags:
    - RHEL-09-232040
    - permissions
    - CAT II

- name: RHEL-09-232040 | Reset cronie file permissions to defaults
  ansible.builtin.command:
    cmd: rpm --setperms cronie
  register: rhel_rke2_stig_cronie_perms
  changed_when: rhel_rke2_stig_cronie_perms.rc == 0
  when:
    - rhel_rke2_stig_file_permissions_enabled | default(true)
    - rhel_rke2_stig_cron_permissions_enabled | default(true)
    - rhel_rke2_stig_cronie_check.rc == 0
  tags:
    - RHEL-09-232040
    - permissions
    - CAT II

- name: RHEL-09-232040 | Reset cronie file ownership to defaults
  ansible.builtin.command:
    cmd: rpm --setugids cronie
  register: rhel_rke2_stig_cronie_ugids
  changed_when: rhel_rke2_stig_cronie_ugids.rc == 0
  when:
    - rhel_rke2_stig_file_permissions_enabled | default(true)
    - rhel_rke2_stig_cron_permissions_enabled | default(true)
    - rhel_rke2_stig_cronie_check.rc == 0
  tags:
    - RHEL-09-232040
    - permissions
    - CAT II

- name: RHEL-09-232040 | Check if crontabs package is installed
  ansible.builtin.command:
    cmd: rpm -q crontabs
  register: rhel_rke2_stig_crontabs_check
  changed_when: false
  failed_when: false
  when:
    - rhel_rke2_stig_file_permissions_enabled | default(true)
    - rhel_rke2_stig_cron_permissions_enabled | default(true)
  tags:
    - RHEL-09-232040
    - permissions
    - CAT II

- name: RHEL-09-232040 | Reset crontabs file permissions to defaults
  ansible.builtin.command:
    cmd: rpm --setperms crontabs
  register: rhel_rke2_stig_crontabs_perms
  changed_when: rhel_rke2_stig_crontabs_perms.rc == 0
  when:
    - rhel_rke2_stig_file_permissions_enabled | default(true)
    - rhel_rke2_stig_cron_permissions_enabled | default(true)
    - rhel_rke2_stig_crontabs_check.rc == 0
  tags:
    - RHEL-09-232040
    - permissions
    - CAT II

- name: RHEL-09-232040 | Reset crontabs file ownership to defaults
  ansible.builtin.command:
    cmd: rpm --setugids crontabs
  register: rhel_rke2_stig_crontabs_ugids
  changed_when: rhel_rke2_stig_crontabs_ugids.rc == 0
  when:
    - rhel_rke2_stig_file_permissions_enabled | default(true)
    - rhel_rke2_stig_cron_permissions_enabled | default(true)
    - rhel_rke2_stig_crontabs_check.rc == 0
  tags:
    - RHEL-09-232040
    - permissions
    - CAT II

###########################################################
# STIG ID: RHEL-09-232245    Group ID: V-257929
# Rule Title: A sticky bit must be set on all RHEL 9 public directories.
# Severity: CAT II
# Note: Finds world-writable directories without sticky bit and sets it.
#   This prevents users from deleting files owned by others.
###########################################################
- name: RHEL-09-232245 | Find world-writable directories without sticky bit
  ansible.builtin.shell:
    cmd: find / -xdev -type d \( -perm -0002 -a ! -perm -1000 \) 2>/dev/null || true
  register: rhel_rke2_stig_sticky_bit_dirs
  changed_when: false
  when:
    - rhel_rke2_stig_file_permissions_enabled | default(true)
    - rhel_rke2_stig_sticky_bit_enabled | default(true)
  tags:
    - RHEL-09-232245
    - permissions
    - CAT II

- name: RHEL-09-232245 | Set sticky bit on world-writable directories
  ansible.builtin.file:
    path: "{{ item }}"
    mode: "o+t"
  loop: "{{ rhel_rke2_stig_sticky_bit_dirs.stdout_lines | default([]) }}"
  when:
    - rhel_rke2_stig_file_permissions_enabled | default(true)
    - rhel_rke2_stig_sticky_bit_enabled | default(true)
    - rhel_rke2_stig_sticky_bit_dirs.stdout_lines | default([]) | length > 0
  tags:
    - RHEL-09-232245
    - permissions
    - CAT II

###########################################################
# STIG ID: RHEL-09-232045    Group ID: V-257889
# Rule Title: All RHEL 9 local initialization files must have mode 0740 or
#   less permissive.
# Severity: CAT II
# WARNING: Disabled by default - modifying user dotfiles can break
#   environments. Enable only after verifying impact.
###########################################################
- name: RHEL-09-232045 | Find overly permissive initialization files
  ansible.builtin.shell:
    cmd: |
      for dir in /home/*; do
        if [ -d "$dir" ]; then
          find "$dir" -maxdepth 1 -name ".*" -type f -perm /037 2>/dev/null
        fi
      done
  register: rhel_rke2_stig_init_files
  changed_when: false
  when:
    - rhel_rke2_stig_file_permissions_enabled | default(true)
    - rhel_rke2_stig_init_files_enabled | default(false)
  tags:
    - RHEL-09-232045
    - permissions
    - CAT II

- name: RHEL-09-232045 | Restrict initialization files to mode 0740
  ansible.builtin.file:
    path: "{{ item }}"
    mode: "0740"
  loop: "{{ rhel_rke2_stig_init_files.stdout_lines | default([]) }}"
  when:
    - rhel_rke2_stig_file_permissions_enabled | default(true)
    - rhel_rke2_stig_init_files_enabled | default(false)
    - rhel_rke2_stig_init_files.stdout_lines | default([]) | length > 0
  tags:
    - RHEL-09-232045
    - permissions
    - CAT II

###########################################################
# STIG ID: RHEL-09-232250    Group ID: V-257930
# Rule Title: All RHEL 9 local files and directories must have a valid
#   group owner.
# Severity: CAT II
# WARNING: Disabled by default - auto-remediation can cause application
#   failures. Enable only after manual review.
# Note: Excludes rhel_rke2_stig_rancher_base_path because container files
#   use UIDs/GIDs that don't map to host users. When SSSD is enabled, also
#   excludes rhel_rke2_stig_domain_home_path for AD/IPA user home dirs.
#   See README.md exemption documentation.
###########################################################
- name: RHEL-09-232250 | Find files without valid group owner
  ansible.builtin.shell:
    cmd: >-
      set -o pipefail &&
      find / -xdev
      -path {{ rhel_rke2_stig_rancher_base_path }} -prune -o
      {% if rhel_rke2_stig_sssd_enabled | default(false) and rhel_rke2_stig_domain_home_path | default('') | length > 0 %}
      -path {{ rhel_rke2_stig_domain_home_path }} -prune -o
      {% endif %}
      -nogroup -print 2>/dev/null |
      head -100 || true
    executable: /bin/bash
  register: rhel_rke2_stig_nogroup_files
  changed_when: false
  when:
    - rhel_rke2_stig_file_permissions_enabled | default(true)
    - rhel_rke2_stig_orphan_files_enabled | default(false)
  tags:
    - RHEL-09-232250
    - permissions
    - CAT II

- name: RHEL-09-232250 | Assign root group to orphaned files
  ansible.builtin.file:
    path: "{{ item }}"
    group: root
  loop: "{{ rhel_rke2_stig_nogroup_files.stdout_lines | default([]) }}"
  when:
    - rhel_rke2_stig_file_permissions_enabled | default(true)
    - rhel_rke2_stig_orphan_files_enabled | default(false)
    - rhel_rke2_stig_nogroup_files.stdout_lines | default([]) | length > 0
  tags:
    - RHEL-09-232250
    - permissions
    - CAT II

###########################################################
# STIG ID: RHEL-09-232255    Group ID: V-257931
# Rule Title: All RHEL 9 local files and directories must have a valid
#   owner.
# Severity: CAT II
# WARNING: Disabled by default - auto-remediation can cause application
#   failures. Enable only after manual review.
# Note: Excludes rhel_rke2_stig_rancher_base_path because container files
#   use UIDs/GIDs that don't map to host users. When SSSD is enabled, also
#   excludes rhel_rke2_stig_domain_home_path for AD/IPA user home dirs.
#   See README.md exemption documentation.
###########################################################
- name: RHEL-09-232255 | Find files without valid owner
  ansible.builtin.shell:
    cmd: >-
      set -o pipefail &&
      find / -xdev
      -path {{ rhel_rke2_stig_rancher_base_path }} -prune -o
      {% if rhel_rke2_stig_sssd_enabled | default(false) and rhel_rke2_stig_domain_home_path | default('') | length > 0 %}
      -path {{ rhel_rke2_stig_domain_home_path }} -prune -o
      {% endif %}
      -nouser -print 2>/dev/null |
      head -100 || true
    executable: /bin/bash
  register: rhel_rke2_stig_nouser_files
  changed_when: false
  when:
    - rhel_rke2_stig_file_permissions_enabled | default(true)
    - rhel_rke2_stig_orphan_files_enabled | default(false)
  tags:
    - RHEL-09-232255
    - permissions
    - CAT II

- name: RHEL-09-232255 | Assign root owner to orphaned files
  ansible.builtin.file:
    path: "{{ item }}"
    owner: root
  loop: "{{ rhel_rke2_stig_nouser_files.stdout_lines | default([]) }}"
  when:
    - rhel_rke2_stig_file_permissions_enabled | default(true)
    - rhel_rke2_stig_orphan_files_enabled | default(false)
    - rhel_rke2_stig_nouser_files.stdout_lines | default([]) | length > 0
  tags:
    - RHEL-09-232255
    - permissions
    - CAT II

###########################################################
# STIG ID: RHEL-09-252050    Group ID: V-257951
# Rule Title: RHEL 9 must be configured to prevent unrestricted mail
#   relaying.
# Severity: CAT II
# Note: Configures postfix smtpd_client_restrictions if postfix is installed.
###########################################################
- name: RHEL-09-252050 | Check if postfix is installed
  ansible.builtin.command:
    cmd: rpm -q postfix
  register: rhel_rke2_stig_postfix_check
  changed_when: false
  failed_when: false
  when: rhel_rke2_stig_postfix_enabled | default(true)
  tags:
    - RHEL-09-252050
    - mail
    - CAT II

- name: RHEL-09-252050 | Configure postfix to prevent mail relay
  ansible.builtin.command:
    cmd: "postconf -e 'smtpd_client_restrictions={{ rhel_rke2_stig_postfix_client_restrictions }}'"
  register: rhel_rke2_stig_postfix_result
  changed_when: rhel_rke2_stig_postfix_result.rc == 0
  notify: Reload postfix
  when:
    - rhel_rke2_stig_postfix_enabled | default(true)
    - rhel_rke2_stig_postfix_check.rc == 0
  tags:
    - RHEL-09-252050
    - mail
    - CAT II

###########################################################
# STIG ID: RHEL-09-255095    Group ID: V-257995
# Rule Title: RHEL 9 must be configured so that all network connections
#   associated with SSH traffic terminate after becoming unresponsive.
# Severity: CAT II
# Note: Works in conjunction with ClientAliveInterval (RHEL-09-255100) to
#   terminate unresponsive sessions.
###########################################################
- name: RHEL-09-255095 | Check if sshd_config exists
  ansible.builtin.stat:
    path: /etc/ssh/sshd_config
  register: rhel_rke2_stig_sshd_config_check
  when: rhel_rke2_stig_ssh_enabled | default(true)
  tags:
    - RHEL-09-255095
    - RHEL-09-255100
    - ssh
    - CAT II

- name: RHEL-09-255095 | Set SSH ClientAliveCountMax
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^\s*#*\s*ClientAliveCountMax\s+'
    line: 'ClientAliveCountMax {{ rhel_rke2_stig_ssh_client_alive_count_max }}'
    state: present
  notify: Restart sshd
  when:
    - rhel_rke2_stig_ssh_enabled | default(true)
    - rhel_rke2_stig_sshd_config_check.stat.exists | default(false)
  tags:
    - RHEL-09-255095
    - ssh
    - CAT II

###########################################################
# STIG ID: RHEL-09-255100    Group ID: V-257996
# Rule Title: RHEL 9 must be configured so that all network connections
#   associated with SSH traffic are terminated after 10 minutes of becoming
#   unresponsive.
# Severity: CAT II
# Note: ClientAliveInterval * ClientAliveCountMax = max idle time before
#   disconnect. With CountMax=1 and Interval=600, session terminates after
#   10 minutes of unresponsiveness.
###########################################################
- name: RHEL-09-255100 | Set SSH ClientAliveInterval
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^\s*#*\s*ClientAliveInterval\s+'
    line: 'ClientAliveInterval {{ rhel_rke2_stig_ssh_client_alive_interval }}'
    state: present
  notify: Restart sshd
  when:
    - rhel_rke2_stig_ssh_enabled | default(true)
    - rhel_rke2_stig_sshd_config_check.stat.exists | default(false)
  tags:
    - RHEL-09-255100
    - ssh
    - CAT II

###########################################################
# STIG ID: RHEL-09-255035    Group ID: V-257983
# Rule Title: RHEL 9 SSHD must accept public key authentication.
# Severity: CAT II
# Note: If an approved alternate multifactor authentication method is used,
#   this requirement is Not Applicable.
###########################################################
- name: RHEL-09-255035 | Enable SSH public key authentication
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^\s*#*\s*PubkeyAuthentication\s+'
    line: 'PubkeyAuthentication yes'
    state: present
  notify: Restart sshd
  when:
    - rhel_rke2_stig_ssh_enabled | default(true)
    - rhel_rke2_stig_sshd_config_check.stat.exists | default(false)
  tags:
    - RHEL-09-255035
    - ssh
    - CAT II

###########################################################
# STIG ID: RHEL-09-255070    Group ID: V-270178
# Rule Title: The RHEL 9 SSH client must be configured to use only
#   DOD-approved Message Authentication Codes (MACs) employing FIPS 140-3
#   validated cryptographic hash algorithms to protect the confidentiality
#   of SSH client connections.
# Severity: CAT II
# Note: OSCAP checks require MACs in specific order. The crypto policy
#   backend file is used rather than sshd_config per STIG guidance.
###########################################################
- name: RHEL-09-255070 | Configure SSH client crypto policy MACs
  ansible.builtin.lineinfile:
    path: /etc/crypto-policies/back-ends/openssh.config
    regexp: '^MACs\s+'
    line: "MACs hmac-sha2-256-etm@openssh.com,hmac-sha2-512-etm@openssh.com,hmac-sha2-256,hmac-sha2-512"
    create: true
    owner: root
    group: root
    mode: '0644'
  notify: Restart sshd
  when:
    - rhel_rke2_stig_ssh_enabled | default(true)
    - rhel_rke2_stig_sshd_config_check.stat.exists | default(false)
  tags:
    - RHEL-09-255070
    - ssh
    - CAT II

###########################################################
# STIG ID: RHEL-09-255075    Group ID: V-257991
# Rule Title: The RHEL 9 SSH server must be configured to use only Message
#   Authentication Codes (MACs) employing FIPS 140-3 validated cryptographic
#   hash algorithms to protect the confidentiality of SSH server connections.
# Severity: CAT II
# Note: OSCAP checks require MACs in specific order. The crypto policy
#   backend file is used rather than sshd_config per STIG guidance.
###########################################################
- name: RHEL-09-255075 | Configure SSH server crypto policy MACs
  ansible.builtin.lineinfile:
    path: /etc/crypto-policies/back-ends/opensshserver.config
    regexp: '^MACs\s+'
    line: "MACs hmac-sha2-256-etm@openssh.com,hmac-sha2-512-etm@openssh.com,hmac-sha2-256,hmac-sha2-512"
    create: true
    owner: root
    group: root
    mode: '0644'
  notify: Restart sshd
  when:
    - rhel_rke2_stig_ssh_enabled | default(true)
    - rhel_rke2_stig_sshd_config_check.stat.exists | default(false)
  tags:
    - RHEL-09-255075
    - ssh
    - CAT II

###########################################################
# STIG ID: RHEL-09-255070    Group ID: V-270178
# Rule Title: The RHEL 9 SSH client must be configured to use only
#   DOD-approved Message Authentication Codes (MACs) employing FIPS 140-3
#   validated cryptographic hash algorithms to protect the confidentiality
#   of SSH client connections.
# Severity: CAT II
# Note: MACs in ssh_config override crypto policy. Remove to ensure policy
#   backend settings take effect.
###########################################################
- name: RHEL-09-255070 | Remove MACs override from SSH client config
  ansible.builtin.lineinfile:
    path: /etc/ssh/ssh_config
    regexp: '^\s*MACs\s+'
    state: absent
  notify: Restart sshd
  when: rhel_rke2_stig_ssh_enabled | default(true)
  tags:
    - RHEL-09-255070
    - ssh
    - CAT II

###########################################################
# STIG ID: RHEL-09-255075    Group ID: V-257991
# Rule Title: The RHEL 9 SSH server must be configured to use only Message
#   Authentication Codes (MACs) employing FIPS 140-3 validated cryptographic
#   hash algorithms to protect the confidentiality of SSH server connections.
# Severity: CAT II
# Note: MACs in sshd_config override crypto policy. Remove to ensure policy
#   backend settings take effect.
###########################################################
- name: RHEL-09-255075 | Remove MACs override from SSH server config
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^\s*MACs\s+'
    state: absent
  notify: Restart sshd
  when:
    - rhel_rke2_stig_ssh_enabled | default(true)
    - rhel_rke2_stig_sshd_config_check.stat.exists | default(false)
  tags:
    - RHEL-09-255075
    - ssh
    - CAT II

###########################################################
# STIG ID: RHEL-09-252040    Group ID: V-257949
# Rule Title: RHEL 9 must configure a DNS processing mode in Network Manager.
# Severity: CAT II
# Note: Common DNS modes are 'default' (use resolv.conf), 'dnsmasq', or
#   'systemd-resolved'. 'default' maintains traditional DNS resolution behavior.
###########################################################
- name: RHEL-09-252040 | Check if NetworkManager is installed
  ansible.builtin.stat:
    path: /etc/NetworkManager/NetworkManager.conf
  register: rhel_rke2_stig_nm_conf_check
  when: rhel_rke2_stig_nm_dns_enabled | default(true)
  tags:
    - RHEL-09-252040
    - networkmanager
    - CAT II

- name: RHEL-09-252040 | Configure NetworkManager DNS mode
  community.general.ini_file:
    path: /etc/NetworkManager/NetworkManager.conf
    section: main
    option: dns
    value: '{{ rhel_rke2_stig_nm_dns_mode }}'
    mode: '0644'
    backup: true
  notify: Reload NetworkManager
  when:
    - rhel_rke2_stig_nm_dns_enabled | default(true)
    - rhel_rke2_stig_nm_conf_check.stat.exists | default(false)
  tags:
    - RHEL-09-252040
    - networkmanager
    - CAT II

###########################################################
# STIG IDs: RHEL-09-654010 through RHEL-09-654255
# Group IDs: V-258176 through V-258225
# Rule Title: Deploy all STIG-required audit rules for system call
#   monitoring, privileged command execution, and identity file changes.
#   This template covers 50 individual STIG audit requirements.
# Severity: CAT II
###########################################################
- name: RHEL-09-654xxx | Deploy STIG audit rules
  ansible.builtin.template:
    src: 20-stig.rules.j2
    dest: /etc/audit/rules.d/20-stig.rules
    owner: root
    group: root
    mode: '0640'
  notify: Reload auditd rules
  tags:
    - RHEL-09-654010
    - audit
    - CAT II

###########################################################
# STIG IDs: RHEL-09-213045, RHEL-09-213050, RHEL-09-213055,
#   RHEL-09-213060, RHEL-09-213065, RHEL-09-231195, RHEL-09-291010,
#   RHEL-09-291035
# Group IDs: V-257804 through V-257808, V-257880, V-258034, V-258039
# Rule Title: Deploy kernel module blacklist to disable unnecessary and
#   potentially dangerous kernel modules (ATM, CAN, FireWire, SCTP, TIPC,
#   cramfs, USB storage, Bluetooth). Covers 8 STIG requirements.
# Severity: CAT II / CAT III
###########################################################
- name: RHEL-09-213xxx | Deploy kernel module blacklist
  ansible.builtin.template:
    src: blacklist.conf.j2
    dest: /etc/modprobe.d/blacklist.conf
    owner: root
    group: root
    mode: '0644'
  tags:
    - RHEL-09-213045
    - kernel
    - CAT II

###########################################################
# STIG ID: RHEL-09-433016    Group ID: V-270180
# Rule Title: The RHEL 9 fapolicy module must be configured to employ a
#   deny-all, permit-by-exception policy to allow the execution of authorized
#   software programs.
# Severity: CAT II
# Note: Supplements RKE2 RPM-provided rules (80-rke2.rules) with additional
#   paths for Longhorn, local-path-provisioner, and optional components.
###########################################################
- name: RHEL-09-433016 | Deploy supplemental fapolicyd rules for RKE2
  ansible.builtin.template:
    src: 60-rke2.rules.j2
    dest: /etc/fapolicyd/rules.d/60-rke2.rules
    owner: root
    group: root
    mode: '0644'
  notify: Reload fapolicyd rules
  when: rhel_rke2_stig_fapolicyd_enabled | default(true)
  tags:
    - RHEL-09-433016
    - fapolicyd
    - CAT II

###########################################################
# STIG ID: N/A (Operational)    Group ID: N/A
# Rule Title: Load kernel modules required for RKE2 Kubernetes networking
#   including bridge/netfilter, IPVS, iptables, NAT, and overlay modules.
#   These modules are NOT on the STIG blacklist.
# Severity: N/A
###########################################################
- name: RKE2-MODULES | Deploy kernel modules configuration
  ansible.builtin.copy:
    src: rke2-modules.conf
    dest: /etc/modules-load.d/rke2-modules.conf
    owner: root
    group: root
    mode: '0644'
  tags:
    - rke2
    - kernel

###########################################################
# STIG ID: RHEL-09-253075 (EXEMPTION)    Group ID: V-257970
# Rule Title: RHEL 9 must not enable IPv4 packet forwarding unless the system
#   is a router. EXEMPTION REQUIRED: Kubernetes nodes require IP forwarding
#   for pod-to-pod networking. Document with ISSO per STIG guidance.
# Severity: CAT II
###########################################################
- name: RKE2-SYSCTL | Deploy sysctl settings (EXEMPTION RHEL-09-253075)
  ansible.builtin.copy:
    src: 98-rke2.conf
    dest: /etc/sysctl.d/98-rke2.conf
    owner: root
    group: root
    mode: '0644'
  notify: Reload sysctl
  tags:
    - rke2
    - sysctl
    - RHEL-09-253075
    - CAT II

###########################################################
# STIG ID: RHEL-09-253075, RHEL-09-213105 (EXEMPTIONS)
# Rule Title: Override STIG base sysctl settings that conflict with
#   Kubernetes networking. Uses 99-zzz- prefix to load AFTER the STIG
#   base config (99-sysctl.conf symlink to /etc/sysctl.conf).
# Severity: CAT II
# Note: STIG profile sets net.ipv4.conf.all.forwarding=0 which conflicts
#   with Kubernetes requirements. This file ensures our exempted settings
#   take precedence regardless of STIG base configuration.
###########################################################
- name: RKE2-SYSCTL | Deploy STIG override sysctl settings
  ansible.builtin.template:
    src: 99-zzz-rke2-stig-override.conf.j2
    dest: /etc/sysctl.d/99-zzz-rke2-stig-override.conf
    owner: root
    group: root
    mode: '0644'
  notify: Reload sysctl
  tags:
    - rke2
    - sysctl
    - RHEL-09-253075
    - RHEL-09-213105
    - CAT II

###########################################################
# STIG ID: N/A (Operational)    Group ID: N/A
# Rule Title: Configure NetworkManager to ignore CNI-managed interfaces.
#   Prevents interference with Canal/Calico/Flannel virtual interfaces.
# Severity: N/A
###########################################################
- name: RKE2-NETWORK | Deploy NetworkManager CNI ignore configuration
  ansible.builtin.copy:
    src: rke2-canal.conf
    dest: /etc/NetworkManager/conf.d/rke2-canal.conf
    owner: root
    group: root
    mode: '0644'
  notify: Reload NetworkManager
  tags:
    - rke2
    - networkmanager

###########################################################
# STIG ID: N/A (Supplements AU-2, AU-3, AU-12)    Group ID: N/A
# Rule Title: Deploy RKE2-specific audit rules for Kubernetes environments.
#   Audits RKE2 binaries, config, PKI, container runtime, network changes.
# Severity: CAT II
###########################################################
- name: RKE2-AUDIT | Deploy RKE2-specific audit rules
  ansible.builtin.copy:
    src: 10-rke2-server.rules
    dest: /etc/audit/rules.d/10-rke2-server.rules
    owner: root
    group: root
    mode: '0640'
  notify: Reload auditd rules
  tags:
    - rke2
    - audit
    - CAT II

###########################################################
# STIG ID: RHEL-09-251015 (EXEMPTION)    Group ID: V-257936
# Rule Title: The firewalld service on RHEL 9 must be active. EXEMPTION
#   REQUIRED: RKE2 uses iptables directly for pod networking. Running
#   firewalld concurrently causes unpredictable cluster failures. RKE2's
#   iptables rules provide equivalent network filtering.
# Severity: CAT II
# Also Affects: RHEL-09-251020 (V-257937) - deny-all firewall policy
###########################################################
- name: RKE2-FIREWALL | Disable firewalld (EXEMPTION RHEL-09-251015)
  ansible.builtin.systemd:
    name: firewalld
    state: stopped
    enabled: false
    masked: true
  tags:
    - rke2
    - firewall
    - RHEL-09-251015
    - RHEL-09-251020
    - CAT II
