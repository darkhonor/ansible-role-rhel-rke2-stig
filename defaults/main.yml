---
###############################################################################
# Filename: defaults/main.yml
# Role: ansible-role-rhel-rke2-stig
# Summary: Default variables for RHEL RKE2 STIG compliance role. These can be
#   overridden in playbooks or inventory to customize behavior.
# Last Updated: 23 Jan 2026
# Classification: UNCLASSIFIED
###############################################################################

###############################################################################
# fapolicyd Configuration - Application Whitelisting (RHEL-09-433016)
# Note: These rules SUPPLEMENT the RKE2 RPM-provided rules (80-rke2.rules).
#   The RPM covers /var/lib/rancher/, /opt/cni/, /run/k3s/, /var/lib/kubelet/.
#   This role adds explicit rules for Longhorn/local-path storage paths and
#   optional components like Helm.
###############################################################################
# Enable/disable supplemental fapolicyd rules deployment
rhel_rke2_stig_fapolicyd_enabled: true

# Longhorn CSI storage path - where Longhorn stores volume data
# Default: /var/lib/rancher/longhorn
# WARNING: Allowing execution from persistent volumes is a security tradeoff.
#   Only enable if workloads genuinely need to execute binaries from PVs.
rhel_rke2_stig_longhorn_storage_path: /var/lib/rancher/longhorn

# Local Path Provisioner storage path - where local-path-provisioner stores PVs
# Default: /var/lib/rancher/local-path-provisioner
# WARNING: Allowing execution from local PVs is a security tradeoff.
#   Only enable if workloads genuinely need to execute binaries from PVs.
rhel_rke2_stig_local_path_storage_path: /var/lib/rancher/local-path-provisioner

###############################################################################
# Cryptographic Policy Configuration (RHEL-09-215105)
# Configures the system-wide cryptographic policy using update-crypto-policies.
###############################################################################
# Enable/disable crypto policy management by this role
rhel_rke2_stig_crypto_policy_enabled: true

# System-wide cryptographic policy to apply
# Options:
#   - FIPS              Pure FIPS 140-3 mode (may break AD/IPA integration)
#   - FIPS:AD-SUPPORT   FIPS with Active Directory compatibility (RECOMMENDED)
#   - FIPS:OSPP         FIPS with OSPP (Protection Profile) requirements
#
# Default: FIPS:AD-SUPPORT
#   Enables FIPS 140-3 compliant cryptography while allowing RC4 for Kerberos
#   authentication with Active Directory. Required for environments using:
#   - FreeIPA/Red Hat IdM with AD trust
#   - Direct AD domain membership via SSSD/realmd
#   - Cross-realm Kerberos with Windows domains
#
# Note: Automated scanners (e.g., Nessus) may flag FIPS:AD-SUPPORT as
#   non-compliant. See README.md STIG Exemptions section for documentation
#   to provide to assessors explaining the technical nuance.
rhel_rke2_stig_crypto_policy: "FIPS:AD-SUPPORT"

###############################################################################
# SSH Configuration (RHEL-09-255095, RHEL-09-255100)
# Configures SSH ClientAlive settings to terminate unresponsive sessions.
###############################################################################
# Enable/disable SSH hardening by this role
rhel_rke2_stig_ssh_enabled: true

# ClientAliveCountMax: Number of unresponded keepalive messages before disconnect
# STIG requires: 1 (session terminates after first missed keepalive)
rhel_rke2_stig_ssh_client_alive_count_max: 1

# ClientAliveInterval: Seconds between keepalive messages to the client
# STIG requires: 600 or less (10 minutes maximum idle before disconnect)
# Note: Total idle timeout = ClientAliveInterval * ClientAliveCountMax
#   With defaults: 600 * 1 = 600 seconds (10 minutes) max idle time
rhel_rke2_stig_ssh_client_alive_interval: 600

###############################################################################
# NetworkManager Configuration (RHEL-09-252040)
# Configures DNS processing mode in NetworkManager.
###############################################################################
# Enable/disable NetworkManager DNS mode configuration by this role
rhel_rke2_stig_nm_dns_enabled: true

# DNS processing mode for NetworkManager
# Options:
#   - default   Use resolv.conf directly (traditional behavior)
#   - dnsmasq   Use local dnsmasq caching server
#   - systemd-resolved  Use systemd-resolved for DNS
#   - none      NetworkManager does not modify resolv.conf
#
# Default: 'default' maintains traditional /etc/resolv.conf behavior and
#   ensures DNS server settings from DHCP/static config are properly applied.
rhel_rke2_stig_nm_dns_mode: "default"

###############################################################################
# User Namespaces Configuration (RHEL-09-213105 EXEMPTION)
# Kubernetes containers require user namespaces for UID isolation and security.
# STIG wants this disabled (0), but that breaks container isolation.
###############################################################################
# Maximum number of user namespaces allowed
# Default: 15000 (sufficient for most Kubernetes deployments)
# Note: Adjust based on expected pod density and container requirements.
#   Higher values may be needed for:
#   - High pod density nodes (100+ pods)
#   - Workloads using rootless containers
#   - Nested container scenarios
rhel_rke2_stig_user_namespaces_max: 15000

###############################################################################
# Password Hashing Configuration (RHEL-09-611050, RHEL-09-611055)
# Configures SHA512 hashing rounds for password-auth and system-auth.
###############################################################################
# Enable/disable PAM password hashing configuration by this role
rhel_rke2_stig_pam_password_enabled: true

# Number of SHA512 hashing rounds for password storage
# STIG requires: minimum 100000 rounds
# Higher values increase security but also CPU time for password operations
rhel_rke2_stig_pam_sha512_rounds: 100000

###############################################################################
# Smart Card / CAC Configuration (RHEL-09-611160)
# Configures OpenSC to use the DoD Common Access Card (CAC) driver.
###############################################################################
# Enable/disable CAC smart card driver configuration
# Default: false (not all environments use CAC/PIV smart cards)
# Set to true if your environment requires smart card authentication
rhel_rke2_stig_smartcard_enabled: false

###############################################################################
# SSSD Configuration (RHEL-09-631015, RHEL-09-631020)
# Configures certificate mapping and cached credential expiration.
###############################################################################
# Enable/disable SSSD configuration by this role
# Default: false (SSSD configuration is environment-specific)
rhel_rke2_stig_sssd_enabled: false

# Offline credentials expiration in days (RHEL-09-631020)
# STIG requires: 1 day maximum
# Note: Only applies when cache_credentials = true in sssd.conf
rhel_rke2_stig_sssd_offline_cred_expiration: 1

# Certificate mapping configuration (RHEL-09-631015)
# Enable/disable certificate mapping in SSSD
# Default: false (requires environment-specific configuration)
rhel_rke2_stig_sssd_certmap_enabled: false

# Domain name for certificate mapping (e.g., "example.mil")
# This must match your SSSD domain configuration
rhel_rke2_stig_sssd_certmap_domain: ""

# Certificate mapping rule name
rhel_rke2_stig_sssd_certmap_rule_name: "cac_mapping"

# Match rule for certificate Subject Alternative Name (SAN)
# Example for DoD CAC: "<SAN>.*EDIPI@mil"
# Adjust regex pattern to match your certificate format
rhel_rke2_stig_sssd_certmap_matchrule: "<SAN>.*EDIPI@mil"

# Map rule to locate user account from certificate
# Common options:
#   - (userCertificate;binary={cert!bin})  - Match full certificate in LDAP
#   - (altSecurityIdentities={subject_dn}) - Match by subject DN
rhel_rke2_stig_sssd_certmap_maprule: "(userCertificate;binary={cert!bin})"
